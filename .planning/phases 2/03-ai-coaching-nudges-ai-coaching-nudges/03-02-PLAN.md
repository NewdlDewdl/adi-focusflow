---
phase: 03-ai-coaching-nudges
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/hooks/useAICoaching.ts
  - src/components/coaching/NudgeIndicator.tsx
  - src/components/detection/DetectionProvider.tsx
autonomous: false

must_haves:
  truths:
    - "Distracted user hears a spoken coaching nudge within 2 seconds of trigger threshold"
    - "No nudge fires during the first 60 seconds of a session"
    - "No nudge fires closer than 30 seconds after the previous one"
    - "No nudge fires while focus score is actively recovering (trending up)"
    - "Consecutive distraction events escalate: gentle then medium then direct"
    - "Visual nudge indicator appears on screen during voice playback with tier-colored styling"
    - "Application delivers nudges via browser speech when ElevenLabs is unavailable"
    - "Session start triggers background audio pre-cache warm-up"
  artifacts:
    - path: "src/hooks/useAICoaching.ts"
      provides: "Rewritten coaching hook using coaching-engine state machine, Gemini text, and cached audio"
      exports: ["useAICoaching"]
    - path: "src/components/coaching/NudgeIndicator.tsx"
      provides: "Visual nudge indicator with tier-colored styling, pulse animation, and coaching text display"
      exports: ["default"]
    - path: "src/components/detection/DetectionProvider.tsx"
      provides: "Updated provider wiring useAICoaching with score, sessionStartTime, and NudgeIndicator"
  key_links:
    - from: "src/hooks/useAICoaching.ts"
      to: "src/lib/coaching-engine.ts"
      via: "imports canTriggerNudge, createNudgeState, advanceEscalation, updateScoreHistory"
      pattern: "import.*coaching-engine"
    - from: "src/hooks/useAICoaching.ts"
      to: "/api/coaching/generate"
      via: "fetch call for Gemini text generation"
      pattern: "fetch.*api/coaching/generate"
    - from: "src/hooks/useAICoaching.ts"
      to: "/api/elevenlabs/speak"
      via: "fetch call for TTS audio"
      pattern: "fetch.*api/elevenlabs/speak"
    - from: "src/hooks/useAICoaching.ts"
      to: "/api/coaching/precache"
      via: "fetch call on session start for audio warm-up"
      pattern: "fetch.*api/coaching/precache"
    - from: "src/components/detection/DetectionProvider.tsx"
      to: "src/hooks/useAICoaching.ts"
      via: "hook call with score and sessionStartTime"
      pattern: "useAICoaching"
    - from: "src/components/detection/DetectionProvider.tsx"
      to: "src/components/coaching/NudgeIndicator.tsx"
      via: "renders NudgeIndicator with isPlaying, tier, and message props"
      pattern: "NudgeIndicator"
---

<objective>
Rewrite the useAICoaching hook to use the coaching engine state machine, Gemini-generated text, and cached audio playback. Create the NudgeIndicator visual component and wire everything into DetectionProvider.

Purpose: Delivers the complete user-facing coaching experience -- from distraction detection through voice playback to visual feedback. This plan makes all 11 requirements (COACH-01 through COACH-10, UI-04) functional end-to-end.
Output: Rewritten useAICoaching hook, NudgeIndicator component, updated DetectionProvider with full coaching integration.
</objective>

<execution_context>
@/Users/adiga/.claude/get-shit-done/workflows/execute-plan.md
@/Users/adiga/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-ai-coaching-nudges-ai-coaching-nudges/03-RESEARCH.md
@.planning/phases/03-ai-coaching-nudges-ai-coaching-nudges/03-01-SUMMARY.md
@src/hooks/useAICoaching.ts
@src/hooks/useFocusChime.ts
@src/components/detection/DetectionProvider.tsx
@src/lib/coaching-engine.ts
@src/lib/coaching-prompts.ts
@src/lib/coaching-cache.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite useAICoaching hook with coaching engine integration</name>
  <files>
    src/hooks/useAICoaching.ts
  </files>
  <action>
    Rewrite useAICoaching.ts to use the coaching-engine state machine from Plan 01. The hook signature changes to accept more data:

    ```typescript
    export function useAICoaching(
      score: number,
      chimeCount: number,
      sessionStartTime: number | null,
      config?: Partial<CoachingConfig>
    ): { isPlaying: boolean; currentTier: EscalationTier | null; currentMessage: string | null }
    ```

    **CoachingConfig interface** (updated):
    - chimesToActivate: number (default 5) -- chimes before first voice trigger
    - cooldownSeconds: number (default 30) -- matches COACH-04
    - enableEscalation: boolean (default true)
    - gracePeriodSeconds: number (default 60) -- matches COACH-08

    **Internal state (useRef):**
    - nudgeStateRef: useRef<NudgeState | null>(null) -- lazily initialized from createNudgeState(sessionStartTime) when sessionStartTime becomes non-null
    - isPlayingRef: useRef(false) -- prevents double triggers
    - hasTriggeredForCurrentChimeSessionRef: useRef(false)
    - previousChimeCountRef: useRef(0)

    **useState:**
    - [isPlaying, setIsPlaying] -- for UI reactivity
    - [currentTier, setCurrentTier] -- for NudgeIndicator coloring
    - [currentMessage, setCurrentMessage] -- for NudgeIndicator text display

    **Pre-cache warm-up:** When sessionStartTime transitions from null to a number (session starts), fire `fetch("/api/coaching/precache", { method: "POST" })` in background (no await, fire-and-forget with .catch for error logging). This warms the audio cache.

    **Score history tracking:** On every score change, call `updateScoreHistory(nudgeStateRef.current, score)` and store result back in ref.

    **Escalation reset:** On every score update, call `shouldResetEscalation(nudgeStateRef.current)` -- if true, reset escalationLevel to 0 in the ref.

    **Main trigger logic (useEffect on chimeCount):**
    1. If chimeCount === 0 and previousChimeCountRef.current > 0: reset hasTriggeredForCurrentChimeSessionRef to false. Do NOT reset escalation here (escalation persists across distraction events per COACH-07, only resets via shouldResetEscalation).
    2. Update previousChimeCountRef.
    3. If chimeCount >= chimesToActivate AND !hasTriggeredRef AND !isPlayingRef:
       a. Call canTriggerNudge(nudgeStateRef.current, score) -- if not allowed, log reason and return
       b. Set hasTriggeredRef = true, isPlayingRef = true, setIsPlaying(true)
       c. Determine tier via getEscalationTier(nudgeStateRef.current.escalationLevel)
       d. setCurrentTier(tier)
       e. Call playCoachingNudge(tier)

    **playCoachingNudge(tier) -- async function:**
    1. Fetch coaching text: `const res = await fetch("/api/coaching/generate", { method: "POST", body: JSON.stringify({ tier, context: buildContext() }) })`
       - buildContext() returns `{ sessionMinutes, distractionCount }` from nudge state
       - On fetch failure, pick random phrase from local COACHING_MESSAGES fallback (keep a small local set for offline resilience)
    2. Set currentMessage to the text
    3. Try ElevenLabs: `const audioRes = await fetch("/api/elevenlabs/speak", { method: "POST", body: JSON.stringify({ text }) })`
       - If ok: create Audio from blob URL, set onended to cleanup, await play()
       - If not ok: fall through to browser speech fallback
    4. SpeechSynthesis fallback (COACH-06):
       - Create SpeechSynthesisUtterance(text)
       - Set rate=1.0, pitch=1.0, volume=1.0
       - Return a Promise that resolves on utterance.onend
       - Add safety timeout of 10 seconds (research pitfall 5) that resolves the promise if onend never fires
    5. After playback completes (either path):
       - Update nudgeStateRef: lastNudgeTime = Date.now(), call advanceEscalation
       - Reset: isPlayingRef = false, setIsPlaying(false), setCurrentTier(null), setCurrentMessage(null)

    **Cleanup on unmount:** Pause any active audio, cancel speech synthesis, clear refs.

    **IMPORTANT behavioral notes:**
    - Do NOT reset escalation when chimeCount goes to 0 (this was a bug in the old code). Escalation only resets via shouldResetEscalation (sustained high focus).
    - The SpeechSynthesis fallback must wait for onend (not fire-and-forget like the old code). Use the Promise + safety timeout pattern from research.
    - Keep a small FALLBACK_MESSAGES constant (3 phrases per tier, hardcoded) for when both Gemini API and network are completely down.
  </action>
  <verify>
    1. `npx tsc --noEmit` passes
    2. `npm run build` succeeds
    3. Verify hook imports from coaching-engine.ts (canTriggerNudge, createNudgeState, etc.)
    4. Verify hook signature accepts (score, chimeCount, sessionStartTime, config?)
    5. Verify hook returns { isPlaying, currentTier, currentMessage }
    6. Verify SpeechSynthesis fallback uses onend callback (not immediate setIsPlaying(false))
    7. Verify escalation is NOT reset when chimeCount goes to 0
    8. Verify pre-cache warm-up fires when sessionStartTime transitions from null to number
  </verify>
  <done>
    useAICoaching hook is fully rewritten. Uses coaching-engine state machine for timing/escalation. Fetches Gemini-generated text. Plays via ElevenLabs with SpeechSynthesis fallback (with proper onend handling and 10s safety timeout). Pre-cache warm-up fires on session start. Escalation persists across distraction events within session.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create NudgeIndicator component and wire coaching into DetectionProvider</name>
  <files>
    src/components/coaching/NudgeIndicator.tsx
    src/components/detection/DetectionProvider.tsx
  </files>
  <action>
    **src/components/coaching/NudgeIndicator.tsx** -- Visual nudge indicator (UI-04):

    "use client" component, default export.

    Props interface:
    ```typescript
    interface NudgeIndicatorProps {
      isActive: boolean;
      tier: "gentle" | "medium" | "direct" | null;
      message: string | null;
    }
    ```

    Renders nothing when `!isActive`.

    When active, renders a fixed-position or inline indicator with:
    - Tier-colored styling:
      - gentle: blue/cyan theme (bg-blue-900/60, text-blue-300, border-blue-700/50)
      - medium: amber/yellow theme (bg-amber-900/60, text-amber-300, border-amber-700/50)
      - direct: red theme (bg-red-900/60, text-red-300, border-red-700/50)
    - Animated pulse dot (matching tier color) using CSS animate-pulse
    - Label text: "AI Coach" for gentle, "Focus Alert" for medium, "Focus Now!" for direct
    - Message text displayed below the label in smaller font (the actual coaching phrase)
    - Framer-motion AnimatePresence + motion.div for enter/exit animation (fade in from top, fade out)
    - Rounded-lg with backdrop-blur-sm for glass effect, matching the existing UI style
    - Width: fits content, max-w-sm, centered within its container

    Use lucide-react icons: Volume2 icon next to the label (already in package.json).

    **src/components/detection/DetectionProvider.tsx** -- Wire coaching:

    1. Update useAICoaching call to pass new params:
       ```typescript
       const { isPlaying: isCoachingActive, currentTier, currentMessage } = useAICoaching(
         score,
         chimeCount,
         detectionStartRef.current,  // sessionStartTime (null until detection ready)
         { chimesToActivate: 5, cooldownSeconds: 30, enableEscalation: true }
       );
       ```

    2. Import NudgeIndicator from "@/components/coaching/NudgeIndicator"

    3. Replace the existing inline coaching indicator div:
       ```tsx
       {/* Old code to REMOVE: */}
       {isCoachingActive && (
         <div className="flex items-center gap-2 rounded-lg bg-blue-900/50 ...">
           ...AI Coach Speaking...
         </div>
       )}
       ```
       Replace with:
       ```tsx
       <NudgeIndicator
         isActive={isCoachingActive}
         tier={currentTier}
         message={currentMessage}
       />
       ```

    4. The NudgeIndicator should be placed at the top of the right column (same position as the old indicator), inside the scoring sidebar div.

    5. Ensure no other changes to DetectionProvider -- the existing FocusScoreRing, Sparkline, StatCards, SensitivitySlider remain exactly as-is.
  </action>
  <verify>
    1. `npx tsc --noEmit` passes
    2. `npm run build` succeeds
    3. Verify NudgeIndicator.tsx exists with default export
    4. Verify NudgeIndicator accepts { isActive, tier, message } props
    5. Verify DetectionProvider imports NudgeIndicator
    6. Verify DetectionProvider passes score and detectionStartRef.current to useAICoaching
    7. Verify the old inline coaching indicator div is removed from DetectionProvider
    8. Verify framer-motion AnimatePresence is used for enter/exit animation
  </verify>
  <done>
    NudgeIndicator component renders tier-colored visual feedback during voice playback with enter/exit animations. DetectionProvider wires the rewritten useAICoaching hook with score, chimeCount, and sessionStartTime, rendering NudgeIndicator with the current tier and message. The complete coaching pipeline is functional end-to-end.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete AI coaching nudge pipeline: Gemini text generation, ElevenLabs Flash v2.5 TTS with caching, SpeechSynthesis fallback, nudge timing engine (60s grace, 30s cooldown, recovery suppression), escalation tiers (gentle/medium/direct), visual NudgeIndicator with tier-colored styling, and background audio pre-caching.
  </what-built>
  <how-to-verify>
    1. Run `npm run dev` and open http://localhost:3000/session
    2. Grant webcam permission and wait for detection to start
    3. **Grace period test**: Look away from screen immediately -- confirm NO voice nudge during first 60 seconds (check browser console for "[useAICoaching] grace-period" log)
    4. **Nudge trigger test**: After 60 seconds, look away for 15-20 seconds until chimes start. After ~5 chimes, you should hear a spoken coaching nudge. Verify:
       - Voice plays through speakers (ElevenLabs or browser speech)
       - NudgeIndicator appears with blue/cyan styling (gentle tier)
       - Message text is visible on the indicator
       - Indicator disappears when speech ends
    5. **Cooldown test**: Look away again immediately after a nudge -- confirm no second nudge within 30 seconds (console: "cooldown" reason)
    6. **Recovery suppression test**: Start losing focus, then look back at screen while score is trending up -- confirm no nudge fires during recovery (console: "recovering" reason)
    7. **Escalation test**: Trigger 2-3 nudges across the session by repeatedly losing focus:
       - First nudge: gentle (blue indicator)
       - Second nudge: medium (amber indicator)
       - Third nudge: direct (red indicator)
    8. **Fallback test**: Stop the dev server, restart without ELEVENLABS_API_KEY in .env.local. Look away until nudge triggers -- confirm browser speech synthesis speaks the message (may sound robotic but should work)
    9. Check browser console for any errors or unexpected behavior
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues observed</resume-signal>
</task>

</tasks>

<verification>
1. `npm run build` completes with no errors
2. Full coaching pipeline works: distraction detected -> text generated -> audio played -> indicator shown
3. Timing constraints enforced: 60s grace, 30s cooldown, recovery suppression
4. Escalation works: gentle -> medium -> direct across session
5. Fallback works: browser speech when ElevenLabs unavailable
6. NudgeIndicator shows tier-appropriate colors and coaching text
7. Pre-cache warm-up fires on session start (check console for "[Coaching] Audio cache warmed up" or "[Precache]" logs)
</verification>

<success_criteria>
- User who loses focus for sustained period hears spoken coaching within 2 seconds of trigger threshold
- No nudge during first 60 seconds, no nudge within 30 seconds of previous, no nudge during recovery
- Escalation visible through indicator color changes across consecutive distraction events
- Visual indicator appears during playback with coaching text and disappears when speech ends
- Application works with browser speech fallback when ElevenLabs is unavailable
</success_criteria>

<output>
After completion, create `.planning/phases/03-ai-coaching-nudges-ai-coaching-nudges/03-02-SUMMARY.md`
</output>
