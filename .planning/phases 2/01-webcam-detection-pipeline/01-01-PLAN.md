---
phase: 01-webcam-detection-pipeline
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - tsconfig.json
  - next.config.ts
  - tailwind.config.ts
  - postcss.config.mjs
  - src/app/globals.css
  - src/app/layout.tsx
  - src/app/page.tsx
  - src/lib/human-config.ts
  - src/lib/detection-types.ts
  - src/hooks/useWebcamPermission.ts
  - src/components/detection/PermissionGate.tsx
  - src/components/detection/PrivacyIndicator.tsx
autonomous: true

must_haves:
  truths:
    - "User can grant webcam permission with a clear pre-permission screen explaining privacy"
    - "User sees 'video never leaves your device' privacy indicator while camera is active"
    - "User who denies or dismisses webcam permission sees a clear, helpful error message with recovery instructions"
    - "Next.js dev server starts and renders the home page without errors"
  artifacts:
    - path: "src/hooks/useWebcamPermission.ts"
      provides: "Permission state machine with all getUserMedia error handling"
      exports: ["useWebcamPermission"]
    - path: "src/components/detection/PermissionGate.tsx"
      provides: "Pre-permission screen and error UI"
      min_lines: 40
    - path: "src/components/detection/PrivacyIndicator.tsx"
      provides: "Persistent camera-active badge"
      min_lines: 10
    - path: "src/lib/human-config.ts"
      provides: "Human.js configuration for focus tracking"
      exports: ["humanConfig"]
    - path: "src/lib/detection-types.ts"
      provides: "TypeScript types for detection results"
      exports: ["FaceDetectionData", "DetectionResult", "PerformanceMetrics"]
  key_links:
    - from: "src/components/detection/PermissionGate.tsx"
      to: "src/hooks/useWebcamPermission.ts"
      via: "useWebcamPermission hook call"
      pattern: "useWebcamPermission"
    - from: "src/app/page.tsx"
      to: "src/components/detection/PermissionGate.tsx"
      via: "dynamic import with ssr: false"
      pattern: "dynamic.*ssr.*false"
---

<objective>
Scaffold the Next.js 15 project with Human.js, create the webcam permission flow, and establish the type system for face detection data.

Purpose: This plan creates the project foundation and the first user-facing experience -- the webcam permission gate. The permission flow is the literal first thing users experience; if it breaks, nothing else matters. The Human.js config and type definitions established here are consumed by all subsequent plans.

Output: A running Next.js 15 app with a pre-permission screen, webcam access with full error handling, a persistent privacy indicator, Human.js installed and configured, and TypeScript types for detection results.
</objective>

<execution_context>
@/Users/adiga/.claude/get-shit-done/workflows/execute-plan.md
@/Users/adiga/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-webcam-detection-pipeline/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Scaffold Next.js 15 project with Human.js and configure detection</name>
  <files>
    package.json
    tsconfig.json
    next.config.ts
    tailwind.config.ts
    postcss.config.mjs
    src/app/globals.css
    src/app/layout.tsx
    src/app/page.tsx
    src/lib/human-config.ts
    src/lib/detection-types.ts
  </files>
  <action>
    Initialize a Next.js 15 project in the repository root using `npx create-next-app@15 . --typescript --tailwind --app --src-dir --yes` (the `.` installs in current directory). If the command refuses because the directory is not empty, use `--skip-install` and manually configure, or use a temp directory and move files.

    After scaffold, install Human.js: `npm install @vladmandic/human`

    Do NOT install @tensorflow/tfjs separately -- Human.js bundles TensorFlow.js 4.17.0 internally.

    Create `src/lib/human-config.ts` with the optimized configuration for focus tracking:
    - Backend: `'humangl'` (NOT `'webgl'` -- HumanGL has 3.6x faster warmup: ~6s vs ~22s)
    - modelBasePath: `'https://cdn.jsdelivr.net/npm/@vladmandic/human/models/'`
    - cacheModels: true (IndexedDB caching after first load)
    - cacheSensitivity: 0.70 (skip detection if input changed less than 30%)
    - deallocate: false (start with false, switch to true only if tensor count climbs during Phase 1 Plan 03 testing)
    - warmup: 'full' (fastest first detection after warmup)
    - face.enabled: true, face.mesh.enabled: true, face.iris.enabled: true
    - face.detector.rotation: true, face.detector.maxDetected: 1, face.detector.return: false (CRITICAL: false prevents tensor leak)
    - face.detector.skipFrames: 99, face.detector.skipTime: 2500
    - Disable everything not needed: body, hand, object, segmentation, face.emotion, face.description, face.attention, face.antispoof, face.liveness
    - gesture.enabled: true (detects head nod/shake, useful for future scoring)
    - filter.enabled: true, filter.autoBrightness: true, filter.return: true

    Create `src/lib/detection-types.ts` with TypeScript interfaces matching Human.js result structure:
    - `FaceDetectionData`: id, score, boxScore, faceScore, box, rotation (angle with yaw/pitch/roll in radians, gaze with bearing/strength), mesh, annotations, distance
    - `DetectionResult`: faces array, performance record, timestamp
    - `PerformanceMetrics`: fps, tensorCount, numBytes, isLeaking boolean
    - `PermissionState`: union type 'idle' | 'checking' | 'prompt' | 'granted' | 'denied' | 'error'

    Update `src/app/layout.tsx` with basic metadata (title: "FocusFlow", description: "AI-powered focus coaching").

    Update `src/app/page.tsx` to be a Server Component that uses `next/dynamic` to import DetectionProvider with `{ ssr: false }`. Show a loading skeleton while the client component loads. For now, the DetectionProvider can be a placeholder that renders the PermissionGate.

    In `next.config.ts`, add webpack config to handle Human.js WASM/WebGL files if needed (Human.js may need `serverComponentsExternalPackages` or similar). The key constraint: Human.js must NEVER be imported in a server context.
  </action>
  <verify>
    1. `npm run dev` starts without errors
    2. `http://localhost:3000` renders the page
    3. `npx tsc --noEmit` passes with no type errors
    4. `src/lib/human-config.ts` exists and exports `humanConfig`
    5. `src/lib/detection-types.ts` exports `FaceDetectionData`, `DetectionResult`, `PerformanceMetrics`, `PermissionState`
  </verify>
  <done>
    Next.js 15 app runs on localhost:3000. Human.js is installed. Human.js config is optimized for focus tracking (face + mesh + iris only, HumanGL backend). TypeScript types are defined for all detection results. No type errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build webcam permission state machine with pre-permission UI and privacy indicator</name>
  <files>
    src/hooks/useWebcamPermission.ts
    src/components/detection/PermissionGate.tsx
    src/components/detection/PrivacyIndicator.tsx
    src/components/detection/DetectionProvider.tsx
    src/app/page.tsx
  </files>
  <action>
    Create `src/hooks/useWebcamPermission.ts`:
    - State machine: idle -> checking -> prompt -> granted | denied | error
    - On mount, call `navigator.permissions.query({ name: 'camera' as PermissionName })` to check permission state WITHOUT triggering the browser prompt
    - Listen for permission change events (user changes in browser settings)
    - `requestPermission()` function calls `navigator.mediaDevices.getUserMedia({ video: { width: { ideal: 640 }, height: { ideal: 480 }, facingMode: 'user' } })`
    - On success: store stream in ref, attach to videoRef, set state to 'granted'
    - On error: catch by `err.name` with specific, actionable messages for each:
      - NotAllowedError: "Camera access denied. Click the camera icon in your address bar, then select 'Allow'."
      - NotFoundError: "No camera found. Please connect a webcam and try again."
      - NotReadableError: "Camera is in use by another application. Close other apps using the camera and try again."
      - OverconstrainedError: "Camera does not support the required settings. Try a different camera."
      - Default: "Camera error: {message}"
    - Cleanup on unmount: `stream.getTracks().forEach(t => t.stop())` (CRITICAL: stops green camera LED)
    - Return: { state, error, videoRef, requestPermission }
    - Use the PermissionState type from detection-types.ts

    Create `src/components/detection/PermissionGate.tsx` (client component):
    - Uses useWebcamPermission hook
    - When state is 'prompt': show a pre-permission screen with:
      - Heading: "FocusFlow needs camera access"
      - Explanation: "We use your webcam to detect face direction and eye gaze. Video is processed entirely in your browser -- it never leaves your device."
      - Privacy bullet points: "No video recording", "No data sent to servers", "Camera can be stopped at any time"
      - "Enable Camera" button that calls requestPermission()
    - When state is 'checking': show a subtle loading spinner
    - When state is 'denied' or 'error': show the error message from the hook with clear, actionable instructions. Include a "Try Again" button that calls requestPermission() again.
    - When state is 'granted': render children (which will be the detection view in Plan 02)
    - Style with Tailwind CSS: centered card layout, professional but friendly appearance

    Create `src/components/detection/PrivacyIndicator.tsx` (client component):
    - Small, persistent badge shown when camera is active
    - Shows a green dot + "Camera Active" text
    - Includes "Video stays on your device" tooltip or subtitle text
    - Positioned in top-right corner or header area using fixed/sticky positioning
    - Only renders when camera state is 'granted'

    Create `src/components/detection/DetectionProvider.tsx` (client component):
    - Wraps PermissionGate
    - When permission is granted, shows:
      - The video element (hidden for now, or a small preview)
      - The PrivacyIndicator
      - A placeholder message: "Camera connected. Detection pipeline will be enabled in the next plan."
    - This is the component loaded via `next/dynamic({ ssr: false })` from page.tsx

    Update `src/app/page.tsx` to dynamically import DetectionProvider with appropriate loading state.
  </action>
  <verify>
    1. Visit http://localhost:3000 -- pre-permission screen appears with privacy messaging
    2. Click "Enable Camera" -- browser permission dialog appears
    3. Grant permission -- camera LED turns on, privacy indicator appears, video preview shows
    4. Deny permission (test in incognito) -- clear error message with recovery instructions appears
    5. Component unmount (navigate away or close tab) -- camera LED turns off (stream tracks stopped)
    6. `npx tsc --noEmit` passes
  </verify>
  <done>
    Pre-permission screen shows privacy messaging before browser prompt. All getUserMedia error types (NotAllowedError, NotFoundError, NotReadableError, OverconstrainedError) produce specific, actionable error messages. Privacy indicator displays when camera is active. Camera stream is properly cleaned up on unmount. The permission flow works on first visit, denied state, and re-grant.
  </done>
</task>

</tasks>

<verification>
1. `npm run dev` starts the Next.js dev server without errors
2. Pre-permission screen displays on first visit with privacy explanation
3. Granting camera permission activates the webcam with green camera LED
4. Privacy indicator ("Camera Active - Video stays on your device") is visible when camera is active
5. Denying camera permission shows specific, actionable error message
6. Navigating away from the page stops the camera (LED turns off)
7. `npx tsc --noEmit` produces zero errors
8. Human.js configuration file exists with face+mesh+iris enabled, all unnecessary modules disabled
</verification>

<success_criteria>
- Next.js 15 project runs on localhost:3000 with zero errors
- Human.js v3.3.6 installed, configured for focus tracking (HumanGL backend, face+mesh+iris only)
- TypeScript types defined for face detection results, performance metrics, and permission state
- Webcam permission flow handles all getUserMedia error types with specific messages
- Pre-permission screen explains privacy before browser prompt
- Privacy indicator visible when camera is active
- Camera stream cleaned up on unmount (no lingering green LED)
</success_criteria>

<output>
After completion, create `.planning/phases/01-webcam-detection-pipeline/01-01-SUMMARY.md`
</output>
