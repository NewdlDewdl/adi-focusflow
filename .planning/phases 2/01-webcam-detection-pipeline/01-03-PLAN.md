---
phase: 01-webcam-detection-pipeline
plan: 03
type: execute
wave: 3
depends_on: ["01-02"]
files_modified:
  - src/hooks/useTensorMonitor.ts
  - src/components/detection/MonitoringPanel.tsx
  - src/components/detection/DetectionProvider.tsx
autonomous: false

must_haves:
  truths:
    - "User can observe the current FPS rate displayed in a monitoring panel and it stays above 15 FPS during normal use"
    - "Application runs for 30 continuous minutes without crashing, freezing, or accumulating memory (tensor count stays flat)"
    - "User sees tensor count and memory usage in the monitoring panel"
    - "Monitoring panel warns if a memory leak is detected (tensor count climbing steadily)"
  artifacts:
    - path: "src/hooks/useTensorMonitor.ts"
      provides: "Tensor memory monitoring with leak detection"
      exports: ["useTensorMonitor"]
    - path: "src/components/detection/MonitoringPanel.tsx"
      provides: "FPS, tensor count, memory usage, and leak warning display"
      min_lines: 40
  key_links:
    - from: "src/hooks/useTensorMonitor.ts"
      to: "src/hooks/useHumanDetection.ts"
      via: "reads humanRef for tf.memory() access"
      pattern: "humanRef.*tf\\.memory|human\\.tf\\.memory"
    - from: "src/components/detection/MonitoringPanel.tsx"
      to: "src/hooks/useTensorMonitor.ts"
      via: "useTensorMonitor hook call"
      pattern: "useTensorMonitor"
    - from: "src/components/detection/DetectionProvider.tsx"
      to: "src/components/detection/MonitoringPanel.tsx"
      via: "renders MonitoringPanel with detection stats"
      pattern: "MonitoringPanel"
---

<objective>
Build the performance monitoring panel with tensor leak detection and verify the complete pipeline runs stably for 30 continuous minutes.

Purpose: This plan addresses the most critical engineering risk in Phase 1 -- WebGL tensor memory leaks that crash browser tabs after 15-30 minutes (exactly the duration of a target focus session). The monitoring panel gives real-time visibility into FPS, tensor count, and memory usage. The stability checkpoint validates that the entire pipeline (permission -> detection -> rendering) works for 30 minutes without degradation.

Output: A monitoring panel showing FPS, tensor count, and memory stats with leak detection warnings. Verified 30-minute session stability.
</objective>

<execution_context>
@/Users/adiga/.claude/get-shit-done/workflows/execute-plan.md
@/Users/adiga/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-webcam-detection-pipeline/01-RESEARCH.md
@.planning/phases/01-webcam-detection-pipeline/01-01-SUMMARY.md
@.planning/phases/01-webcam-detection-pipeline/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build tensor monitoring hook and performance monitoring panel</name>
  <files>
    src/hooks/useTensorMonitor.ts
    src/components/detection/MonitoringPanel.tsx
    src/components/detection/DetectionProvider.tsx
  </files>
  <action>
    Create `src/hooks/useTensorMonitor.ts` (client component):
    - Accepts humanRef (React.RefObject to Human instance) and optional intervalMs (default 5000ms)
    - Every intervalMs, reads `human.tf.memory()` to get numTensors, numBytes, numDataBuffers
    - Maintains a sliding window of the last 10 tensor count readings
    - Leak detection algorithm: if the last 5 consecutive readings show a strictly increasing tensor count, flag `isLeaking: true`
    - When leak is detected, console.warn with the trend: "[TensorMonitor] Possible memory leak detected! Tensor count: X, trend: A -> B -> C -> D -> E"
    - Returns: `{ numTensors: number, numBytes: number, isLeaking: boolean }`
    - Cleanup: clearInterval on unmount
    - Use the PerformanceMetrics type from detection-types.ts

    Create `src/components/detection/MonitoringPanel.tsx` (client component):
    - Collapsible/toggleable panel positioned in the bottom-right or bottom-left corner
    - Styled with Tailwind: dark semi-transparent background, monospace font, compact layout
    - Shows:
      - **FPS**: Current detection FPS from useHumanDetection (color coded: green >= 15, yellow 10-14, red < 10)
      - **Tensors**: Current numTensors count from useTensorMonitor
      - **Memory**: numBytes formatted as MB (e.g., "23.4 MB")
      - **Status**: "Stable" (green) or "LEAK DETECTED" (red, pulsing) based on isLeaking
      - **Uptime**: Time since detection started (mm:ss format)
    - Include a small toggle button to expand/collapse the panel (default collapsed to not obstruct the webcam view)
    - When isLeaking is true, the panel auto-expands and shows a warning with recommendation: "Tensor count is climbing. Consider enabling deallocate: true in human-config.ts"

    Update `src/components/detection/DetectionProvider.tsx`:
    - Pass humanRef from useHumanDetection to useTensorMonitor
    - Pass FPS, tensor stats, and leak status to MonitoringPanel
    - Render MonitoringPanel alongside the WebcamView
    - Track detection start time for uptime calculation
  </action>
  <verify>
    1. `npm run dev` -- visit http://localhost:3000, grant camera permission
    2. Monitoring panel appears (collapsed by default) in corner
    3. Expand panel -- FPS, tensor count, memory MB, and uptime are displayed
    4. FPS shows detection rate (~5 FPS with 200ms interval)
    5. Tensor count is displayed as a number
    6. Status shows "Stable" in green
    7. Panel is styled with dark background and monospace font
    8. `npx tsc --noEmit` passes
  </verify>
  <done>
    Monitoring panel displays real-time FPS (color-coded), tensor count, memory usage in MB, leak detection status, and session uptime. Tensor monitor checks every 5 seconds with leak detection on 5 consecutive increasing readings. Panel is collapsible with auto-expand on leak detection.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify 30-minute stability and performance</name>
  <what-built>
    Complete webcam detection pipeline: permission flow -> Human.js model loading -> face/gaze/pose detection at 5 Hz -> canvas overlay rendering -> performance monitoring with leak detection.
  </what-built>
  <how-to-verify>
    **Quick functional check (2 minutes):**
    1. Open http://localhost:3000 in Chrome
    2. Grant camera permission -- verify pre-permission screen appeared first
    3. Wait for model loading indicator to complete (~6 seconds)
    4. Verify face detection overlay (bounding box, mesh) appears on webcam feed
    5. Open the monitoring panel -- verify FPS is 4-5 (detection rate), tensor count is displayed
    6. Turn head left/right -- verify yaw angle changes in overlay
    7. Look up/down -- verify pitch angle changes
    8. Look away from screen -- verify gaze bearing changes

    **Stability check (run for 5-10+ minutes, ideally 30):**
    9. Leave the app running with face in frame
    10. Periodically check the monitoring panel:
        - FPS should stay above 15 (detection FPS, not render FPS)
        - Tensor count should stay flat (not climbing steadily)
        - Memory MB should not grow unboundedly
        - Status should remain "Stable" (no leak warning)
    11. Also monitor in Chrome Task Manager (Shift+Esc) -- the tab's memory should not climb continuously

    **Edge cases to test:**
    12. Cover the webcam briefly -- verify app does not crash (face.length === 0 handled)
    13. Move face partially out of frame -- verify no errors
    14. Deny permission in incognito -- verify error message is helpful

    **If any issues found:** Describe what you observe (FPS too low, tensor count climbing, crash, etc.) and I will fix before proceeding to Phase 2.
  </how-to-verify>
  <resume-signal>Type "approved" if pipeline is stable, or describe any issues you observe</resume-signal>
</task>

</tasks>

<verification>
1. Monitoring panel shows FPS >= 15 during normal detection
2. Tensor count stays flat (does not climb over 5+ minutes)
3. Memory usage (MB) is stable, not growing unboundedly
4. Leak detection correctly shows "Stable" during normal operation
5. Panel auto-expands and warns if leak is detected
6. Complete pipeline works: permission -> loading -> detection -> overlay -> monitoring
7. App survives face-not-detected scenarios (covered webcam, face out of frame)
8. 30-minute sustained session completes without crash, freeze, or memory accumulation
</verification>

<success_criteria>
- FPS stays above 15 during sustained detection
- Tensor count remains flat (no steady increase) over 30 minutes
- Monitoring panel displays FPS, tensor count, memory MB, uptime, and leak status
- Leak detection warns when tensor count climbs for 5+ consecutive readings
- Complete pipeline (permission -> detection -> rendering -> monitoring) is stable for 30 continuous minutes
- App handles edge cases (no face, partial face, covered camera) without crashing
</success_criteria>

<output>
After completion, create `.planning/phases/01-webcam-detection-pipeline/01-03-SUMMARY.md`
</output>
