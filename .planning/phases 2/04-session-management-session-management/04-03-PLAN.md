---
phase: 04-session-management
plan: 03
type: execute
wave: 3
depends_on: ["04-02"]
files_modified:
  - src/app/session/page.tsx
  - src/components/session/SessionHistory.tsx
  - src/components/session/StreakBadge.tsx
  - src/components/session/PersonalBests.tsx
autonomous: false

must_haves:
  truths:
    - "User can view past sessions as a list with date, duration, score, and mini timeline chart"
    - "User sees their focus streak (consecutive days) displayed prominently"
    - "User sees personal bests (highest score, longest focus streak, longest session)"
    - "Session history persists across browser sessions (page reload preserves data)"
    - "Interface works correctly on desktop Chrome/Edge at 1024px+ width"
  artifacts:
    - path: "src/components/session/SessionHistory.tsx"
      provides: "Scrollable list of past sessions with mini sparklines and key metrics"
      contains: "SessionHistory"
    - path: "src/components/session/StreakBadge.tsx"
      provides: "Consecutive days streak display with flame icon"
      contains: "StreakBadge"
    - path: "src/components/session/PersonalBests.tsx"
      provides: "Card grid showing best score, longest focus, longest session"
      contains: "PersonalBests"
  key_links:
    - from: "src/app/session/page.tsx"
      to: "src/components/session/SessionHistory.tsx"
      via: "renders history list in idle phase with sessions from loadSessions()"
      pattern: "SessionHistory.*sessions"
    - from: "src/app/session/page.tsx"
      to: "src/lib/session-storage.ts"
      via: "calls loadSessions, calculateStreak, getPersonalBests on mount and after session end"
      pattern: "loadSessions|calculateStreak|getPersonalBests"
    - from: "src/components/session/SessionHistory.tsx"
      to: "src/components/session/SessionTimeline.tsx"
      via: "renders mini SessionTimeline for each past session"
      pattern: "SessionTimeline.*height.*80"
---

<objective>
Build the pre-session dashboard with session history, streak tracking, and personal bests, then verify responsive layout across desktop viewports.

Purpose: This plan completes the session management feature by giving users visibility into their past performance, motivation through streak tracking and personal bests, and a polished desktop experience. The pre-session dashboard is what users see before starting a session and after dismissing a summary.

Output: SessionHistory list component with mini-timeline charts, StreakBadge component, PersonalBests cards, integrated into the session page's idle state, with responsive layout verification.
</objective>

<execution_context>
@/Users/adiga/.claude/get-shit-done/workflows/execute-plan.md
@/Users/adiga/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-session-management-session-management/04-RESEARCH.md
@.planning/phases/04-session-management-session-management/04-01-SUMMARY.md
@.planning/phases/04-session-management-session-management/04-02-SUMMARY.md
@src/app/session/page.tsx
@src/lib/session-storage.ts
@src/components/session/SessionTimeline.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SessionHistory, StreakBadge, and PersonalBests components</name>
  <files>src/components/session/SessionHistory.tsx, src/components/session/StreakBadge.tsx, src/components/session/PersonalBests.tsx</files>
  <action>
**StreakBadge.tsx** - Display consecutive days streak:

- Props: `streak: number`
- Render a compact badge with a flame icon (Flame from lucide-react) and the streak count
- When streak is 0: show "No streak yet" in muted gray
- When streak >= 1: show "{N} day streak" with flame icon in orange/amber color
- When streak >= 7: add a special highlight/glow effect (ring of amber)
- Use framer-motion for a subtle scale pulse animation when streak > 0
- Dark theme styling consistent with the app (gray-900 bg, rounded-lg, border-gray-800)

**PersonalBests.tsx** - Personal bests card grid:

- Props: `bests: { longestFocusStreakMs: number; highestScore: number; longestSessionMs: number }`
- Render three cards in a horizontal row (flex, gap-3):
  1. "Best Score" - Trophy icon, show highestScore as integer (color-coded: green >=70, yellow >=40, red <40)
  2. "Longest Focus" - Brain icon, format longestFocusStreakMs as "Xm Ys"
  3. "Longest Session" - Clock icon, format longestSessionMs as "Xm Ys"
- Each card: gray-900 bg, rounded-lg, border-gray-800, p-3, min-w-0
- If a metric is 0 (no sessions yet), show "--" in muted gray instead of "0"
- Icons from lucide-react (Trophy, Brain, Clock)

**SessionHistory.tsx** - Scrollable list of past sessions:

- Props: `sessions: StoredSession[]`
- If sessions is empty: render an empty state message "No sessions yet. Start your first focus session!" with a subtle Focus icon
- If sessions is non-empty: render a scrollable list (max-h-[400px] overflow-y-auto) sorted by startTime descending (most recent first)
- Each session row (a card-style row with gray-900 bg, rounded-lg, border-gray-800, p-3, mb-2):
  - Left side: Date formatted as "Mon, Feb 8" (use `toLocaleDateString` with options), time as "2:30 PM"
  - Center: Mini SessionTimeline chart (reuse SessionTimeline component with height=60, no axes labels for compact view)
  - Right side: Key metrics stacked vertically: duration (mm:ss), avg score (color-coded), focused %
- Use responsive layout: on larger screens, show the mini chart inline. On smaller desktop screens (< 1024px), hide the mini chart and show metrics only.
- Each row should have a subtle hover effect (border color change or slight bg lighten)
  </action>
  <verify>
```bash
npx tsc --noEmit
grep -rn "export default function" src/components/session/StreakBadge.tsx src/components/session/PersonalBests.tsx src/components/session/SessionHistory.tsx
```
Verify all three components compile and export correctly.
  </verify>
  <done>StreakBadge shows flame icon with streak count and pulse animation. PersonalBests shows 3-card grid with best score, longest focus, longest session. SessionHistory shows scrollable list of past sessions with date, mini timeline chart, and key metrics. All components handle empty/zero states gracefully.</done>
</task>

<task type="auto">
  <name>Task 2: Integrate pre-session dashboard into session page and verify responsive layout</name>
  <files>src/app/session/page.tsx</files>
  <action>
**Integrate pre-session dashboard into idle state:**

1. In session/page.tsx, add state for cached data loaded from localStorage:
   - `sessions: StoredSession[]` - loaded from `loadSessions()` on mount
   - `streak: number` - computed from `calculateStreak(sessions)` on mount
   - `personalBests` - computed from `getPersonalBests(sessions)` on mount

2. Load this data with a `useEffect` on mount (empty deps). Also re-compute after a session ends (when phase transitions from "ended" to "idle" via dismiss).

3. In the idle phase UI, replace the placeholder with the full pre-session dashboard:
   - Header: FocusFlow branding (existing)
   - Below header: StreakBadge (with streak count)
   - Below streak: PersonalBests cards (with bests data)
   - Below bests: SessionControls (shows "Start Focus Session" CTA)
   - Below CTA: SessionHistory list (with past sessions)

4. Layout the idle state as a centered column (max-w-2xl mx-auto) with consistent spacing (gap-6 between sections).

5. When session ends and user dismisses summary, call the `refreshDashboardData()` helper (established in Plan 04-02) to re-load sessions from localStorage and recompute streak and personal bests. This ensures the idle dashboard immediately reflects the just-completed session.

**Responsive layout verification (UI-05):**

6. Verify the layout works at these breakpoints:
   - 1440px+ (large desktop): Two-column layout during session, comfortable spacing
   - 1024px (standard desktop): Two-column layout works, sidebar narrower
   - 768px (small desktop/tablet): Columns stack vertically, all content accessible
   - The idle/pre-session view should work well at all widths since it's single-column

7. Ensure existing responsive classes are correct:
   - DetectionProvider uses `lg:flex-row` (1024px breakpoint) for two-column session layout
   - Pre-session dashboard uses max-w-2xl for centered single-column
   - SessionHistory mini-charts hide below lg breakpoint
   - SessionSummary overlay is responsive (max-w-lg, padding adjusts)

8. Check that all text is readable, no horizontal overflow occurs, and interactive elements have sufficient touch/click targets at narrower widths.

No new CSS breakpoints needed -- the existing Tailwind `lg:` prefix (1024px) handles the desktop responsive split.
  </action>
  <verify>
```bash
npx tsc --noEmit
npm run build
```
Manual verification:
1. Load /session with no prior sessions - see "No sessions yet" empty state, streak shows 0, personal bests show "--"
2. Complete a focus session (>60 seconds) - dismiss summary - see the session in history list with correct stats
3. Refresh page - history, streak, personal bests persist
4. Complete another session on same day - streak shows 1 (today), history shows both sessions
5. Resize browser to 768px width - layout stacks, no horizontal overflow, all controls accessible
6. Resize to 1440px - comfortable spacing, two-column layout during session
  </verify>
  <done>Pre-session dashboard shows streak badge, personal bests, start CTA, and session history loaded from localStorage. Data refreshes after each session. Layout works correctly from 768px to 1440px+ desktop viewports with no overflow or broken elements.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete session management feature: start/pause/resume/end lifecycle, live metrics, session summary with timeline chart, persistent session history, streak tracking, personal bests, and responsive desktop layout.</what-built>
  <how-to-verify>
1. Open http://localhost:3000/session in Chrome
2. Verify pre-session dashboard shows: streak badge, personal bests (-- if first time), "Start Focus Session" button
3. Click "Start Focus Session" - webcam activates, calibration runs, timer begins counting
4. Wait 30 seconds - verify timer counts correctly, live metrics show focused time and distraction count
5. Click Pause - timer freezes, webcam keeps running (video feed visible), score display freezes
6. Click Resume - timer continues from where it paused, scoring resumes immediately
7. Wait until at least 60 seconds total, then click End
8. Verify session summary overlay shows: total time, average score, focused %, distraction count, timeline chart
9. Click Done - verify you return to idle state and the session appears in history list
10. Verify streak badge shows "1 day streak"
11. Verify personal bests show values from the completed session
12. Refresh the page - verify history, streak, and personal bests persist
13. Resize browser to ~768px width - verify no horizontal overflow, layout stacks vertically
14. Start and immediately end a session (<60 seconds) - verify "Session too short" message and session is NOT saved
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. `npm run build` succeeds
3. Pre-session dashboard renders with streak, personal bests, history
4. History persists across page reloads
5. Streak correctly tracks consecutive days
6. Personal bests update after each session
7. Layout is responsive from 768px to 1440px+
8. All requirements covered: SESSION-01 through SESSION-10, UI-05
</verification>

<success_criteria>
- Past sessions visible in scrollable list with date, mini timeline, and metrics
- Streak badge shows correct consecutive day count
- Personal bests display highest score, longest focus streak, longest session
- Data persists in localStorage across browser sessions
- Responsive layout works on desktop Chrome/Edge (768px to 1440px+)
- Human verification confirms complete end-to-end session experience
</success_criteria>

<output>
After completion, create `.planning/phases/04-session-management-session-management/04-03-SUMMARY.md`
</output>
