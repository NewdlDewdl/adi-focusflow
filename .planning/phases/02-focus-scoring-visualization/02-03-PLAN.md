---
phase: 02-focus-scoring-visualization
plan: 03
type: execute
wave: 2
depends_on: ["02-01", "02-02"]
files_modified:
  - src/components/scoring/FocusScoreRing.tsx
  - src/components/scoring/FocusSparkline.tsx
  - src/components/scoring/StatCards.tsx
  - src/components/scoring/SensitivitySlider.tsx
  - src/components/detection/DetectionProvider.tsx
  - src/app/session/page.tsx
autonomous: true

must_haves:
  truths:
    - "User sees a live 0-100 focus score in an animated circular ring that updates in real-time"
    - "Ring color changes based on score level (green >= 70, yellow >= 40, red < 40)"
    - "User sees a sparkline chart showing focus score trend over the session"
    - "User sees stat cards for current score, session duration, and average score"
    - "User can adjust scoring sensitivity through a slider control"
    - "Brief look-away (1-2 seconds) causes no score change; sustained look-away (8-10+ seconds) causes gradual decline"
  artifacts:
    - path: "src/components/scoring/FocusScoreRing.tsx"
      provides: "SVG circular progress ring with score display"
      contains: "strokeDashoffset"
    - path: "src/components/scoring/FocusSparkline.tsx"
      provides: "Recharts sparkline showing score history"
      contains: "LineChart"
    - path: "src/components/scoring/StatCards.tsx"
      provides: "Session metric cards (score, duration, average)"
      contains: "stat"
    - path: "src/components/scoring/SensitivitySlider.tsx"
      provides: "Sensitivity control for scoring algorithm tuning"
      contains: "emaAlpha"
    - path: "src/components/detection/DetectionProvider.tsx"
      provides: "Detection provider now integrating useFocusScore hook"
      contains: "useFocusScore"
  key_links:
    - from: "src/components/detection/DetectionProvider.tsx"
      to: "src/hooks/useFocusScore.ts"
      via: "import and call useFocusScore(result)"
      pattern: "useFocusScore"
    - from: "src/components/scoring/FocusScoreRing.tsx"
      to: "src/components/detection/DetectionProvider.tsx"
      via: "score prop passed from DetectionProvider"
      pattern: "score.*number"
    - from: "src/components/scoring/FocusSparkline.tsx"
      to: "src/components/detection/DetectionProvider.tsx"
      via: "history prop passed from DetectionProvider"
      pattern: "data.*score"
    - from: "src/components/scoring/SensitivitySlider.tsx"
      to: "src/hooks/useFocusScore.ts"
      via: "updateConfig callback passed as prop"
      pattern: "updateConfig|emaAlpha"
---

<objective>
Build the focus score visualization components (SVG ring, sparkline chart, stat cards, sensitivity slider) and wire them into the detection session page with live data from the useFocusScore hook.

Purpose: This is the visible payoff of Phase 2 -- the user sees their focus score updating in real-time with color-coded visual feedback, a trend sparkline, session statistics, and a sensitivity control. Satisfies SCORE-04, SCORE-05, UI-01, UI-02, UI-03, and completes SCORE-06 (tunable sensitivity UI).

Output: Session page at /session displays live focus score ring, sparkline, stat cards, and sensitivity slider alongside the webcam detection view.
</objective>

<execution_context>
@/Users/adiga/.claude/get-shit-done/workflows/execute-plan.md
@/Users/adiga/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-focus-scoring-visualization/02-RESEARCH.md
@.planning/phases/02-focus-scoring-visualization/02-01-SUMMARY.md
@.planning/phases/02-focus-scoring-visualization/02-02-SUMMARY.md
@src/components/detection/DetectionProvider.tsx
@src/hooks/useFocusScore.ts
@src/lib/focus-algorithm.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create score visualization components (ring, sparkline, stat cards, sensitivity slider)</name>
  <files>
    src/components/scoring/FocusScoreRing.tsx
    src/components/scoring/FocusSparkline.tsx
    src/components/scoring/StatCards.tsx
    src/components/scoring/SensitivitySlider.tsx
  </files>
  <action>
    Create four 'use client' components in `src/components/scoring/`:

    **1. FocusScoreRing.tsx** -- SVG circular progress ring (hand-rolled, no library)
    - Props: `score: number` (0-100), `size?: number` (default 200), `strokeWidth?: number` (default 12)
    - SVG with -rotate-90 for top-starting arc
    - Background circle: fill none, stroke rgba(255,255,255,0.1)
    - Progress arc using motion.circle from `framer-motion`:
      - strokeDasharray = circumference
      - animate strokeDashoffset based on score percentage
      - transition: spring with stiffness 60, damping 15
    - Color logic: score >= 70 = green (#22c55e), score >= 40 = yellow (#eab308), < 40 = red (#ef4444)
    - Center text: score number (text-4xl font-bold) with spring scale animation on change (key={Math.round(score)})
    - Label "Focus Score" below the number
    - Fixed width/height in pixels (NOT percentage) to avoid layout thrash
    - See 02-RESEARCH.md "Pattern 4: SVG Circular Progress Ring" for exact implementation

    **2. FocusSparkline.tsx** -- Recharts sparkline
    - Props: `data: { time: number; score: number }[]`, `width?: number | string` (default '100%'), `height?: number` (default 60)
    - Use ResponsiveContainer wrapping LineChart from recharts
    - YAxis with domain [0, 100], hidden
    - Single Line: type monotone, dataKey "score", stroke #3b82f6, strokeWidth 2, dot false
    - isAnimationActive false (avoid animation overhead during real-time updates)
    - SSR guard: useState(false) + useEffect => setMounted(true). If !mounted, render a placeholder div with same dimensions
    - See 02-RESEARCH.md "Pattern 5: Recharts Sparkline" and "Pitfall 5: Recharts SSR Crash"

    **3. StatCards.tsx** -- Three session metric cards
    - Props: `score: number`, `sessionStartTime: number`, `history: { time: number; score: number }[]`
    - Card 1: "Current Score" -- displays current score with color matching the ring color scheme
    - Card 2: "Session Duration" -- computed from Date.now() - sessionStartTime, formatted as mm:ss, updates via useState + setInterval (1s)
    - Card 3: "Average Score" -- computed as mean of history scores, or "--" if no history
    - Each card: dark card styling (bg-gray-900 border border-gray-800 rounded-lg p-4), label (text-gray-400 text-sm), value (text-2xl font-bold)
    - Use cn() from @/lib/utils for class merging

    **4. SensitivitySlider.tsx** -- Scoring sensitivity control
    - Props: `value: number` (current emaAlpha), `onChange: (alpha: number) => void`
    - HTML range input: min 0.05, max 0.4, step 0.01
    - Labels: "Steady" on left (low alpha = more smoothing), "Responsive" on right (high alpha = less smoothing)
    - Display current alpha value (formatted to 2 decimal places)
    - Dark theme styling: accent-blue-500 for the slider track
    - Wrapper: collapsible panel labeled "Scoring Settings" or "Sensitivity" that can be toggled open/closed with a simple useState boolean
  </action>
  <verify>
    - All 4 component files exist in src/components/scoring/
    - Each has 'use client' directive
    - `npx tsc --noEmit` compiles without errors
    - FocusScoreRing imports from framer-motion
    - FocusSparkline imports from recharts
    - StatCards imports cn from @/lib/utils
  </verify>
  <done>
    All four scoring visualization components created: FocusScoreRing (SVG ring with spring animation), FocusSparkline (recharts sparkline with SSR guard), StatCards (3 metric cards), SensitivitySlider (alpha tuning control).
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire scoring into DetectionProvider and session page layout</name>
  <files>
    src/components/detection/DetectionProvider.tsx
    src/app/session/page.tsx
  </files>
  <action>
    **1. Update DetectionProvider.tsx** to integrate focus scoring:
    - Import useFocusScore from @/hooks/useFocusScore
    - Call `const { score, history, config, updateConfig } = useFocusScore(result)` after existing hooks
    - Import and render all scoring components below the webcam view:
      - FocusScoreRing: pass `score`
      - FocusSparkline: pass `history` (renamed `data`)
      - StatCards: pass `score`, `sessionStartTime` (use detectionStartRef.current or Date.now() fallback), `history`
      - SensitivitySlider: pass `value={config.emaAlpha}` and `onChange={(alpha) => updateConfig({ emaAlpha: alpha })}`
    - Layout: Redesign the session view layout for a polished demo feel:
      - Left/main area: Webcam view (keep existing WebcamView component)
      - Right sidebar or below: FocusScoreRing prominently displayed, sparkline below it, stat cards in a row
      - SensitivitySlider in a collapsible section at the bottom or in the sidebar
      - Use Tailwind grid or flex: on large screens, webcam left + scoring right; on smaller screens, stack vertically
      - Keep the detection status bar (face detected, FPS, tensors) but integrate it more cleanly
      - Keep MonitoringPanel (performance panel) available
    - The webcam view should be sized reasonably (not full-width) to make room for the score ring

    **2. Update session/page.tsx** (if needed):
    - The session page (created in 02-01) should already import ClientDetectionLoader
    - Ensure the page has proper layout (full-height, dark theme)
    - If the header from 02-01 is not included, add the FocusFlow header bar

    **Layout guidance (use discretion on exact proportions):**
    ```
    ┌──────────────────────────────────────────┐
    │ FocusFlow header                         │
    ├────────────────────┬─────────────────────┤
    │                    │   [Score Ring]       │
    │   Webcam Feed      │      85             │
    │                    │   Focus Score        │
    │                    │                      │
    │                    │   [Sparkline]        │
    │                    │   ~~~~~~~~           │
    ├────────────────────┤                      │
    │ Face: ● | FPS | T  │   [Stat Cards]      │
    │                    │   Score | Time | Avg │
    ├────────────────────┴─────────────────────┤
    │ Sensitivity: [========|====] Responsive   │
    └──────────────────────────────────────────┘
    ```
  </action>
  <verify>
    - DetectionProvider imports useFocusScore and all scoring components
    - `npx tsc --noEmit` compiles without errors
    - Dev server: navigate to /session, grant camera permission
    - Score ring displays and updates in real-time as user moves head
    - Sparkline shows score trend building up over time
    - Stat cards show current score, session duration (ticking), average score
    - Sensitivity slider adjusts scoring responsiveness
    - Looking away briefly (1-2 seconds) does NOT cause score drop
    - Looking away sustained (8-10+ seconds) causes gradual score decline with color change
    - UI does not stutter or lag during score updates
  </verify>
  <done>
    Detection session at /session shows live focus score ring updating in real-time, sparkline trending, stat cards with metrics, and sensitivity slider. Score responds to sustained attention changes without false alarms on brief glances.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` completes without errors (no SSR crashes from recharts)
2. Navigate to / -- see landing page with animated hero
3. Click "Start Focus Session" -- navigate to /session
4. Grant camera permission -- see webcam + focus score ring + sparkline + stat cards
5. Look directly at camera -- score is high (70-100), ring is green
6. Look away briefly (1-2 seconds), look back -- score unchanged (hysteresis working)
7. Look away sustained (10+ seconds) -- score gradually drops, ring turns yellow then red
8. Look back at camera -- score gradually recovers
9. Adjust sensitivity slider -- scoring responsiveness changes
10. Session duration card ticks up every second
</verification>

<success_criteria>
- Live focus score ring visible and updating during detection session
- Ring color reflects score level (green/yellow/red)
- Sparkline shows accumulating score history
- Stat cards display current score, session duration, and average
- Sensitivity slider adjusts scoring behavior
- No false alarms on brief look-aways (hysteresis + EMA working)
- No SSR errors during build
</success_criteria>

<output>
After completion, create `.planning/phases/02-focus-scoring-visualization/02-03-SUMMARY.md`
</output>
