---
phase: 07-fix-face-mesh-color-calibration-and-focus-score-accuracy
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - src/components/detection/WebcamView.tsx
  - src/hooks/useFocusChime.ts
  - src/components/detection/DetectionProvider.tsx
autonomous: false

must_haves:
  truths:
    - "During calibration, face mesh shows blue/purple color (not gray)"
    - "After calibration completes, face mesh starts green (score=100)"
    - "As score drops, face mesh transitions through yellow, orange, to red"
    - "Chime stops playing when user refocuses, despite display score staying flat"
    - "Color indicator badge matches mesh color (blue/purple during calibration)"
  artifacts:
    - path: "src/components/detection/WebcamView.tsx"
      provides: "Blue/purple calibration color and display-score-based post-calibration colors"
      contains: "[100, 80, 220]"
    - path: "src/hooks/useFocusChime.ts"
      provides: "Recovery detection using instant score average instead of display score"
      contains: "instantScore"
    - path: "src/components/detection/DetectionProvider.tsx"
      provides: "Passes instantScore to useFocusChime for recovery detection"
      contains: "useFocusChime"
  key_links:
    - from: "src/components/detection/DetectionProvider.tsx"
      to: "src/hooks/useFocusChime.ts"
      via: "passes instantScore for recovery detection"
      pattern: "useFocusChime\\(.*instantScore"
    - from: "src/components/detection/WebcamView.tsx"
      to: "getTargetRGB"
      via: "lerped color from display score drives mesh appearance"
      pattern: "getTargetRGB\\(.*isCalibrated"
---

<objective>
Fix face mesh calibration colors and chime recovery logic for the monotonic score model.

Purpose: The face mesh currently shows gray during calibration (should be blue/purple) and uses the noisy instant score for post-calibration colors (should use display score). The chime system uses display score for recovery detection, but since the display score is monotonically decreasing, the chime can never stop once triggered. These visual and audio feedback bugs undermine the user experience.

Output: Blue/purple calibration colors in WebcamView.tsx, display-score-based post-calibration colors, and instant-score-based chime recovery in useFocusChime.ts.
</objective>

<execution_context>
@/Users/adiga/.claude/get-shit-done/workflows/execute-plan.md
@/Users/adiga/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-fix-face-mesh-color-calibration-and-focus-score-accuracy/07-RESEARCH.md
@.planning/phases/07-fix-face-mesh-color-calibration-and-focus-score-accuracy/07-01-SUMMARY.md
@src/components/detection/WebcamView.tsx
@src/hooks/useFocusChime.ts
@src/components/detection/DetectionProvider.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix calibration and post-calibration colors in WebcamView</name>
  <files>src/components/detection/WebcamView.tsx</files>
  <action>
Update both `getTargetRGB()` and `getFocusColors()` functions, and change the color source from instantScore to focusScore (display score) for post-calibration mesh coloring.

**getTargetRGB() -- Fix calibration color:**
Change the uncalibrated return value from gray `[156, 163, 175]` to blue-purple `[100, 80, 220]`:
```typescript
if (!isCalibrated) return [100, 80, 220]; // blue-purple (calibration)
```

Keep all post-calibration color ranges unchanged (they are already correct: red < 25, red-to-orange 25-50, orange-to-yellow 50-75, yellow-to-green 75-100).

**getFocusColors() -- Fix calibration color for DOM badge:**
Change the uncalibrated colors from gray to blue-purple:
```typescript
if (!isCalibrated) {
  return {
    primary: 'rgba(100, 80, 220, 0.8)',   // blue-purple
    secondary: 'rgba(140, 120, 255, 0.9)', // lighter blue-purple
  };
}
```

**Change mesh color source from instantScore to focusScore (display score):**
In the `useEffect` that draws the overlay, change the `getTargetRGB` call from using `instantScore` to using `focusScore`:
```typescript
// BEFORE (line 213):
const targetRGB = getTargetRGB(instantScore, isCalibrated);
// AFTER:
const targetRGB = getTargetRGB(focusScore, isCalibrated);
```

This is critical because `instantScore` is noisy (10-20 point variance frame-to-frame), causing the mesh to flicker between colors. The `focusScore` (display score) changes slowly (1 point at a time, at most once per second), producing smooth, meaningful color transitions. The existing lerping system handles the smooth visual interpolation.

**Update the useEffect dependency array** to remove `instantScore` and add `focusScore` if not already present:
```typescript
}, [result, humanRef, videoRef, fps, focusScore, isCalibrated]);
```

**Update the initial currentColorRef** from gray to blue-purple to match the new calibration color:
```typescript
const currentColorRef = useRef<RGB>([100, 80, 220]); // Start blue-purple (calibration)
```
  </action>
  <verify>
Run `npx tsc --noEmit` to confirm no type errors. Manually review that:
1. getTargetRGB returns [100, 80, 220] when !isCalibrated
2. getFocusColors returns blue-purple rgba values when !isCalibrated
3. getTargetRGB is called with focusScore (not instantScore)
4. currentColorRef starts at [100, 80, 220]
5. useEffect dependency array uses focusScore (not instantScore)
  </verify>
  <done>
Face mesh shows blue/purple during calibration, starts green after calibration (score=100), and smoothly transitions through yellow/orange/red as the display score drops. No flickering from noisy instant scores.
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix chime recovery logic for monotonic score model</name>
  <files>src/hooks/useFocusChime.ts, src/components/detection/DetectionProvider.tsx</files>
  <action>
The chime system currently uses the display score for recovery detection: `const recovery = score - lowestScoreRef.current`. Since the display score is monotonically decreasing (never increases), this condition can never be satisfied once chiming starts, causing infinite chiming after the user refocuses.

**Fix useFocusChime.ts -- Accept and use instantScore for recovery:**

1. Change the hook signature to accept `instantScore` as a second parameter:
```typescript
export function useFocusChime(
  score: number,
  instantScore: number,  // NEW: real-time instant score for recovery detection
  config: Partial<ChimeConfig> = {}
): { chimeCount: number; reset: () => void }
```

2. Add a rolling buffer for instant score averaging (similar to useFocusScore):
```typescript
const recentInstantScoresRef = useRef<number[]>([]);
```

3. In the main useEffect, track instantScore in the rolling buffer:
```typescript
recentInstantScoresRef.current.push(instantScore);
if (recentInstantScoresRef.current.length > 15) {
  recentInstantScoresRef.current.shift(); // Keep last 15 readings (~3 seconds at 5 Hz)
}
const avgInstant = recentInstantScoresRef.current.reduce((a, b) => a + b, 0) / recentInstantScoresRef.current.length;
```

4. Replace the recovery detection logic. Instead of comparing `score - lowestScoreRef.current >= recoveryAmount`, check whether the average instant score is back above a "focused" threshold:
```typescript
// Replace the existing recovery check block with:
if (isChimingRef.current) {
  // Recovery: average instant score is back above focused threshold
  // Use 55 as recovery threshold (higher than the 45 distraction threshold for hysteresis)
  const RECOVERY_THRESHOLD = 55;
  if (avgInstant >= RECOVERY_THRESHOLD) {
    stopChiming();
    baselineScoreRef.current = score;
    lowestScoreRef.current = score;
  }
}
```

5. Update the useEffect dependency array to include `instantScore`:
```typescript
}, [score, instantScore, fullConfig.dropThreshold, fullConfig.recoveryAmount]);
```

6. Update the reset function to also clear the instant score buffer:
```typescript
recentInstantScoresRef.current = [];
```

7. Remove the `recoveryAmount` from ChimeConfig and DEFAULT_CHIME_CONFIG since recovery is now threshold-based, not delta-based. Keep the field in the type for backward compatibility but mark it with a comment that it is unused.

**Fix DetectionProvider.tsx -- Pass instantScore to useFocusChime:**

Change the useFocusChime call to pass instantScore:
```typescript
// BEFORE:
const { chimeCount, reset: resetChime } = useFocusChime(score, {
  dropThreshold: 5,
  chimeIntervalMs: 1500,
});

// AFTER:
const { chimeCount, reset: resetChime } = useFocusChime(score, instantScore, {
  dropThreshold: 5,
  chimeIntervalMs: 1500,
});
```
  </action>
  <verify>
Run `npx tsc --noEmit` to confirm no type errors. Run `npm run build` to confirm successful build. Manually review that:
1. useFocusChime accepts (score, instantScore, config) parameters
2. Recovery detection uses average of recent instant scores >= 55 threshold
3. DetectionProvider passes instantScore to useFocusChime
4. recentInstantScoresRef is cleared in reset()
5. No reference to `score - lowestScoreRef.current >= recoveryAmount` for recovery
  </verify>
  <done>
Chime triggers when display score drops below baseline, and stops when the average instant score returns above the recovery threshold (55), correctly handling the monotonic display score model. User hears chiming when distracted, chiming stops when they refocus.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete scoring and visual feedback pipeline fix:
1. Gaze bearing now measured from 90-degree center (not 0)
2. Scoring weights rebalanced (head=0.6, gaze=0.2, face=0.2)
3. 3-consecutive-second sustained distraction requirement before any score penalty
4. Blue/purple face mesh during calibration
5. Green face mesh after calibration, transitioning to yellow/orange/red as score drops
6. Chime stops when user refocuses (uses instant score for recovery detection)
  </what-built>
  <how-to-verify>
1. Run `npm run dev` and navigate to /session
2. Start a session and observe calibration:
   - Face mesh should be BLUE/PURPLE (not gray) during the calibration progress bar
   - Color indicator badge (top-left) should show blue/purple dot with "CAL" label
3. After calibration completes:
   - Face mesh should immediately show GREEN (score at 100)
   - Score ring should show 100
4. Look directly at the camera for 30+ seconds:
   - Score should stay at 100 the entire time
   - No flickering of mesh colors
5. Look away from the camera for 5+ seconds:
   - Score should NOT decrease for the first 3 seconds
   - After 3 seconds of sustained looking away, score should start decreasing by 1 per second
   - Mesh should transition from green toward yellow/orange as score drops
   - Chime should start playing after the score drops enough
6. Look back at the camera:
   - Score should STOP decreasing and HOLD at its current value (never increase)
   - Chime should stop within a few seconds of refocusing
   - Mesh color should stay at whatever color corresponds to the held score
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues observed</resume-signal>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npx tsc --noEmit` passes with zero errors
2. `npm run build` succeeds
3. Calibration shows blue/purple mesh, post-calibration starts green
4. Score stays at 100 during focused camera gaze
5. Score only drops after 3+ consecutive seconds of looking away
6. Score never increases
7. Chime stops when user refocuses
8. Color transitions are smooth (no flickering)
</verification>

<success_criteria>
- Blue/purple calibration color replaces gray in both getTargetRGB and getFocusColors
- Post-calibration mesh color driven by display score (not instant score)
- Chime recovery uses instant score average >= 55 threshold
- All visual/audio feedback correctly reflects the monotonically-decreasing score model
- User verification confirms the complete fix works end-to-end
</success_criteria>

<output>
After completion, create `.planning/phases/07-fix-face-mesh-color-calibration-and-focus-score-accuracy/07-02-SUMMARY.md`
</output>
